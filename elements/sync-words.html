<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">

<dom-module id="sync-words">
  <template>
    <iron-signals on-iron-signal-sync-words="syncWordSet"></iron-signals>
    <iron-signals on-iron-signal-update-words="updateWordSet"></iron-signals>
    <iron-ajax
      id="wordSetsSource"
      headers='{"Content-Type": "application/json"}'
      method="POST"
      handle-as="json"
      debounce-duration="300"
      on-response="saveWords"></iron-ajax>
    <iron-ajax
      id="wordsSource"
      headers='{"Content-Type": "application/json"}'
      method="POST"
      handle-as="json"
      debounce-duration="300"
      on-response="accumulate"></iron-ajax>
  
      <paper-dialog id="progressDialog" modal="true">
        <div>{{loadingMessage}}</div>
        <paper-progress indeterminate="true"></paper-progress>
      </paper-dialog>
  </template>
</dom-module>

<script>
  // element registration
  Polymer({
    is: "sync-words",
    properties: {
      running: {
        type: Boolean,
        value: false
      },
      loadingMessage: {
        type: String,
        value: 'Loading...'
      }
    },
    syncWordSet: function(e, detail) {
     if (!this.running) {
       this.running = true;
       this.$.progressDialog.open();
       this._syncSets(detail);
     } else {
       // Sync in progress, do nothing
     }
    },
    _syncSets: function(detail) {
      var body = {
       "query": "SELECT B,C",
       "url": "https://docs.google.com/spreadsheets/d/1OPSsdUclv4R-62SFtJB5GV6T6cLweyHoaQvbzIMizo4/edit#gid=0"
      };
      this.$.wordSetsSource.body = JSON.stringify(body);
      this.$.wordSetsSource.url = "https://run.blockspring.com/api_v2/blocks/5496087e640fe656362d754b4d6cd7e6?api_key=br_2967_465b62fbba92324e23358aa9a590600f14fa9c66";
      this.$.wordSetsSource.generateRequest();
    },
    saveWords: function(e, detail) {
      this.running = false;
      var wordSets = detail.response.data;
      if ( wordSets != null && wordSets.length > 0) {
        var pendingSync = wordSets.length;
        var sets = [];

        var makeWordSet = function() {
          var sets = wordSets;  
          var current;

          return {
            getNext: function() {
              current = sets.pop();
              return current;
            },
            isEmpty: function() {
              return sets.length < 1;
            }
          };
        };
        
        var sets = makeWordSet();
        var processed = [];
        while( !sets.isEmpty() ) {
          var set = sets.getNext();
          var body = JSON.stringify({
               "query": "SELECT B,C",
               "url": set.url
             }); 
          var options = {
             "method": "POST",
             "url": "https://run.blockspring.com/api_v2/blocks/5496087e640fe656362d754b4d6cd7e6?api_key=br_2967_465b62fbba92324e23358aa9a590600f14fa9c66",
             "body": body,
             "headers": {
               "Content-Type": "application/json"
             }
          };

          var parentObjectRef = this;

          (function(reqSet, reqOptions) {
            var ajaxReq = document.createElement('iron-request');
            ajaxReq.send(reqOptions).then(
              function(a) { 
                var wordsInSet = JSON.parse(a.parseResponse());
                var wordSet = {
                  "name": reqSet.name,
                  "url": reqSet.url,
                  "words": wordsInSet.data,
                  "md5": md5(reqSet.name + reqSet.url)
                };
                processed.push(wordSet);    
                if ( --pendingSync == 0) {
                  parentObjectRef.fire('iron-signal', {name: "update-words", data: processed});     
                }      
              }, 
              function() { 
               console.log('fuck') 
              });
          }) (set, options);
          
        }
      }
    },
    updateWordSet: function(e, sets) {
      var progressDialog = this.$.progressDialog;
      progressDialog.close();
      console.log(sets);
    } 
  });
</script>
